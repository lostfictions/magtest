<!doctype html>
<html class="no-js" lang="">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>mag testin</title>
    <script src="https://code.createjs.com/createjs-2015.11.26.min.js"></script>
    <script src="https://cdn.rawgit.com/josephg/noisejs/master/perlin.js"></script>
  </head>
  <body>
    <script>
      //Dummy engine functions
      window.harlowe = {
        goToPassage: function(passage) {
          console.log('going to ' + passage);
        }
      };

      /* eslint no-var:0 vars-on-top:0 */
      /* eslint-env node:false es6:false */
      /* global createjs noise */

      function extractItem(arr) {
        var i = Math.floor(Math.random()*arr.length);
        return arr.splice(i, 1)[0];
      }


      var stage, queue;
      var mag;
      var icons = [];
      var beziers = [];

      var rootSrc = 'http://seerscatalogue.github.io/seers/images/';

      var iconSrcPrefix = rootSrc + 'magIcons/';

      var iconFilesToPassages = {
        'Mag-LETTERS.png': 'Mag-LETTERS',
        'Mag-AROUND.png': 'Mag-AROUND TOWN',
        'Mag-OperationPt1.png': 'Mag-OperationPt1',
        'Mag-PLACES.png': 'Mag-PLACES OF NOTE',
        'Mag-REVIEWS.png': 'Mag-REVIEWS',
        'Mag-TIPS.png': 'Mag-TIPS & TRICKS',
        'Mag-OperationPt0.png': 'Mag-OperationPt0',
        'Mag-STYLE.png': 'Mag-STYLE',
        'Mag-OperationPtS.png': 'Mag-OperationPtS',
        'Mag-PROFILE.png': 'Mag-PROFILE'
      };

      var coverSrcPrefix = rootSrc + 'magCovers/';

      var filesToLoad = Object
        .keys(iconFilesToPassages)
        .map(function(src) { return iconSrcPrefix + src; })
        .concat(coverSrcPrefix + 'gardens.jpg');

      window.initMag = function() { //eslint-disable-line no-unused-vars
        queue = new createjs.LoadQueue();
        queue.installPlugin(createjs.Sound);
        queue.on("complete", doMag, this);
        queue.loadManifest(filesToLoad);
      }

      function doMag() { //eslint-disable-line no-unused-vars
        stage = new createjs.Stage("magcanvas");
        stage.enableMouseOver(10);
        createjs.Touch.enable(stage);

        //Draw debug rect
        // var graphics = new createjs.Graphics()
        //   .beginFill("rgba(255,0,0,0.5)")
        //   .drawRect(0, 0, stage.canvas.width, stage.canvas.height);
        // var shape = new createjs.Shape(graphics);
        // stage.addChild(shape);

        var srcs = Object.keys(iconFilesToPassages);
        for(var i=0; i<3; i++) {
          (function(){
            var g = new createjs.Graphics();
            var bez = new createjs.Shape(g);
            stage.addChild(bez);
            beziers.push(g);

            var src = extractItem(srcs);
            var icon = new createjs.Bitmap(queue.getResult(iconSrcPrefix + src));
            stage.addChild(icon);
            icon.initX = icon.x = i < 2 ? 80 + 130 * i : 150;
            icon.initY = icon.y = i < 2 ? 80 : 200;
            icon.scale *= 0.2;
            icon.rotation = -12;
            icon.regX = icon.image.width / 2 | 0;
            icon.regY = icon.image.height / 2 | 0;
            icon.scaleX = icon.scaleY = icon.scale = 0.3;
            icon.cursor = "pointer";

            icon.on("mousedown", function() {
              window.harlowe.goToPassage(iconFilesToPassages[src]);
            });

            icons.push(icon);
          })();
        }

        mag = new createjs.Bitmap(queue.getResult(coverSrcPrefix + 'gardens.jpg'));
        stage.addChild(mag);
        mag.initX = mag.x = 150;
        mag.initY = mag.y = 420;
        mag.scale *= 0.1;
        mag.rotation = -10;
        mag.regX = mag.image.width / 2 | 0;
        mag.regY = mag.image.height / 2 | 0;
        mag.scaleX = mag.scaleY = mag.scale = 0.3;

        createjs.Ticker.timingMode = createjs.Ticker.RAF_SYNCHED;
        createjs.Ticker.setFPS(60);
        createjs.Ticker.on("tick", tick);
      }

      function tick(event) {
        var time = createjs.Ticker.getTime();

        mag.x = mag.initX + 20 * noise.simplex2(100, time / 18000);
        mag.y = mag.initY + 20 * noise.simplex2(time / 20000, 100);
        mag.rotation = -10 + Math.sin(time / 2900) * 4;
        for(var i=0; i<icons.length; i++) {
          var ic = icons[i];
          ic.x = ic.initX + 20 * noise.simplex2(i * 1000, time / 17000);
          ic.y = ic.initY + 20 * noise.simplex2(time / 20000, i * 1000);
          ic.rotation = Math.sin(time / 2900 + i * 1723) * 6;

          var g = beziers[i];
          g.clear();
          g.setStrokeStyle(6);
          g.beginStroke("#000000");
          g.moveTo(ic.x, ic.y);
          g.bezierCurveTo(
            ic.x, ic.y,
            (ic.x + mag.x) / 2 + Math.sin(time / 2000 + i * 100) * 30, (ic.y + mag.y) / 2,
            mag.x + 30 * (i - 1), mag.y
          );
        }

        stage.update(event);
      }
    </script>
    <img
      src="data:image/gif;base64,R0lGODlhAQABAAAAACwAAAAAAQABAAA="
      style="display: none;"
      onload="initMag();">
    <canvas id="magcanvas" width="300" height="600"></canvas>
  </body>
</html>
